# Fantain Automation Build Script
 

#!/bin/bash

#Matrix Table to set the environment for build to be smooth
#--------------------------------------------------------------------------------
#                WEBSITE                                  ANDROID
#--------------------------------------------------------------------------------
#       FANTAIN               SRH                 FANTAIN              SRH
#--------------------------------------------------------------------------------
#DEV      NA                   NA               $devapkfantain      $devapksrh
#--------------------------------------------------------------------------------
#TEST     NA                   NA                  NA                  NA
#--------------------------------------------------------------------------------
#PROD     NA                   NA               $prodapkfantain     $prodapksrh
#--------------------------------------------------------------------------------
  
# Variables 
# common
newline='
'
datetime=$(date +"%d-%m-%Y-%k%M%S")
basedir="$(dirname $0)/buildapplication"
websitedirectory="$basedir/website"
mobiledirectory="$basedir/apk/$datetime"
apkname=$(git rev-parse --abbrev-ref HEAD)
# Environment 
devapkfantain="com.fantain.fantain"
prodapkfantain="com.fantain.comainapp"
devapksrh="com.fantain.srhdev"
prodapksrh="com.fantain.srh"
# Search strings
deployinstallation="##DEPLOYINSTALLATION##"
deployinstance="##DEPLOYINSTANCE##"
deployid="##DEPLOYID##"
deployversion="##DEPLOYVERSION##"
deployversioncode="##DEPLOYVERSIONCODE##"
deployprojectname="##DEPLOYPROJECTNAME##"

# Functions
# Help 
function help {
	echo '
ERROR: These paramters are needed to build fantain application

	      	Try fantainbuild 
			-t {android | website} 
			-i {fantain | srh }
			-s {dev | test | prod}	
			-u {true | false}
			-g {true | false}
			   -n { gittag name }
			   -d { gittag description }
			-v {version number}
			-c {version code number}

Example
------- 

If -g is set to false
fantainbuild -t android -i fantain -s dev -u true -g false -v 3.0 -c 1

If -g is set to  true
fantainbuild -t android -i fantain -s dev -u true -g true -n v1.0 -d "my-git-desc" -v 3.0 -c 1

For Detailed description of the parameters, try man fantainbuild
'
}
# Create a new build folder and copy the codebase to it
function newcodebase {
  	if [ "$(ls -A $websitedirectory)" ]; then
              	sudo cp -v -a -u  .  $websitedirectory
        else
		sudo cp -v -a  . $websitedirectory
	fi
	echo "${newline}Your new codebase is in this location ${newline} $websitedirectory"
	# Files Required to build the application with the complete path
	configxml=$websitedirectory/config.xml
	fantainEnvjs=$websitedirectory/www/js/f/fantainEnv.js
	AndroidManifestxml=$websitedirectory/platforms/android/AndroidManifest.xml
	Buildxml=$websitedirectory/platforms/android/build.xml
}
# Check for important files in the new codebase
function checkfile() {
	if [ -f $1 ] && [ -f $2 ] && [ -f $s3 ]; then
		echo "${newline}Important Files that are needed to create build seems to be good"
	else
		echo "${newline}Files Missing. Go to your root directory and try again" 
	fi
}
# Find the Text and Replace with the platform specific values
function searchandreplace() {
	search=$2
	replace=$3
	search1=$4
	replace1=$5
  	  grep "$search" $1 &> /dev/null
  	  if [ $? -ne 0 ]; then
    		echo "Search string not found in $1!"
  	  else
    		sed -i "s/$search/$replace/" $1
  	  fi
	  grep "$search1" $1 &> /dev/null
          if [ $? -ne 0 ]; then
                echo "Search string not found in $1!"
          else
                sed -i "s/$search1/$replace1/" $1
          fi
}
# Build Application for website
function buildwebsite {
	searchandreplace $fantainEnvjs $deployinstallation $installation $deployinstance $instance
	echo "${newline}Enivronments are set as per your needs"	  
	cd $websitedirectory
        echo "${newline}Fantain Build is Started"
	node r.js -o fantain-build.js
	echo "${newline}Checking Node server status"
	nodestatus=$(pgrep node)
	if [ ! -z $nodestatus ]; then
         	kill -9 $nodestatus
	fi
	echo "${newline}Node Server is up and running"
	echo "${newline}Play is set please view it in your browser"
	node server.js
}
# Build APK for mobiles
function buildapk {
	searchandreplace $fantainEnvjs $deployinstallation $installation $deployinstance $instance
	searchandreplace $configxml $deployversion $version
	searchandreplace $Buildxml $deployprojectname $apkname
	searchandreplace $AndroidManifestxml $deployversioncode $versioncode
	if [ $instance = 'dev' ]; then
		if [ $installation = 'fantain' ]; then
			searchandreplace $configxml $deployid $devapkfantain 
		else
			searchandreplace $configxml $deployid $devapksrh
		fi
	elif [ $instance = 'prod' ]; then
                if [ $installation = 'fantain' ]; then
                        searchandreplace $configxml $deployid $prodapkfantain
                else
                        searchandreplace $configxml $deployid $prodapksrh
                fi
	else
		if [ $installation = 'fantain' ]; then
                        echo "${newline}This installation under contruction.Try again to get your APK"
			exit 
                else
                        echo "${newline}This installation under contruction.Try again to get your APK" 
			exit
                fi
	fi
	echo "${newline}Enivronments are set as per your needs"
	mkdir -p $mobiledirectory
	cd $websitedirectory
	echo "${newline}APK Build process started"
	cordova build
	sudo cp "$websitedirectory/platforms/android/ant-build/$apkname-debug.apk" "$mobiledirectory"
	echo "${newline}Get your new APK at $mobiledirectory"
}


# Trigerring Help Function when there is no paramter
if test $# -eq 0; then
	help
	exit 0
fi

# The build kicksoff from here
# Gettting the parameters from the command 
while getopts t:i:s:u:n:d:g:v:c: option
do
	input=`echo ${OPTARG} | tr '[:upper:]' '[:lower:]'`
        case "${option}"
        in
                t) if [ $input = 'android' ] || [ $input = 'website' ]; then
			platform=$input
		   else
			help 
			exit
	    	   fi;;
                i) if [ $input = 'fantain' ] || [ $input = 'srh' ]; then
                        installation=$input
                   else 
			help 
			exit
                   fi;;
                s) if [ $input = 'dev' ] || [ $input = 'test' ] || [ $input = 'prod' ]; then
                        instance=$input
                   else
			help 
			exit
                   fi;;
                u) if [ $input = 'true' ] || [ $input = 'false' ]; then
                        uglify=$input
                   else 
			help 
			exit
                   fi;;
		n) if [ $input ]; then
                        gittagname=$input
                   else
                        help
                        exit
                   fi;;
		d) if [ $input ]; then
                        gittagdesc=$input
                   else
                        help
                        exit
                   fi;;		
		g) if [ $input = 'true' ]; then
                      if [ -z $gittagname ] || [ -z $gittagdesc ]; then
			help
			exit
		      else
			gittag=$input
		      fi   
	           elif [ $input = 'false' ]; then
		      if [ -z $gittagname ] && [ -z $gittagdesc ]; then
			gittag=$input
		      else
			echo "${newline}WARNING: -g is set to false. -d -n  are ignored for smooth build." 
			echo "${newline}Cleaning you command..." 
			gittag=$input
		   fi
                   else 
			help 
			exit
                   fi;;
	     	v) if [ $input ]; then
                        version=$input
                   else 
			help 
			exit
                   fi;;
	        c) if [ $input ]; then
                        versioncode=$input
                   else 
			help 
			exit
                   fi;;
		*) help
		   exit
        esac
done
# Checking whether all parameters are set to build the application
if [ -z $platform ] || [ -z $installation ] || [ -z $instance ] || [ -z $uglify ] || [ -z $gittag ] || [ -z $version ] || [ -z $versioncode ]; then
	help
	exit
else
	# All set Need to Transfer the Files from working directory
	echo "${newline}Hurray!! All Parameters are Good"
	while true; 
	do
    		read -p "${newline}Are you in Root Directory of your project?(y or n)" yn
    			case $yn in
        			[Yy]* ) # Creating a Base Directories
					if [ ! -d $websitedirectory ]; then
						mkdir -p $websitedirectory
					fi
					# Copying the codebase to a new Folder
					newcodebase
					# Gittagging done for the new codebase
					if [ $gittag = 'true' ]; then
						cd $websitedirectory
						sudo git tag -a $gittagname -m $gittagdesc
					fi
					# Check the important files which are need to build the application
					checkfile $configxml $fantainEnvjs $AndroidManifestxml
					if [ $platform = 'website' ]; then
						sudo cp ./www/js/f/fantainEnv.js $fantainEnvjs 
						buildwebsite
					else
						sudo cp ./www/js/f/fantainEnv.js $fantainEnvjs
						sudo cp ./config.xml $configxml
						sudo cp ./platforms/android/AndroidManifest.xml $AndroidManifestxml
						buildapk
					fi  
					break;;
        			[Nn]* ) # To make the user run the fantainbuild from the root directory
					echo "${newline}Please go to your root directory and try again.Bubie.."
					exit;;
        	    		    * ) # To handle the wrong input given by the user
					echo "${newline}Please enter y or n";;
   		 esac
	done
fi
